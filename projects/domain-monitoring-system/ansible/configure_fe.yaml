---
- name: Configure Frontend Application
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Install Docker engine
      ansible.builtin.apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Ensure Docker service is running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    - name: Log in to Docker Hub
      ansible.builtin.shell: "docker login -u {{ docker_user }} -p {{ docker_password }}"
      register: docker_login_result
      changed_when: false
      no_log: true

    - name: Pull Frontend Image
      ansible.builtin.shell: "docker pull {{ docker_user }}/dms-fe:{{ frontend_version }}"
      register: docker_pull_result

    - name: Extract and customize nginx config with backend IPs
      ansible.builtin.shell: |
        # Pull image if not present
        docker pull {{ docker_user }}/dms-fe:{{ frontend_version }}
        # Create temp container to extract nginx.conf
        docker create --name temp-fe {{ docker_user }}/dms-fe:{{ frontend_version }}
        docker cp temp-fe:/etc/nginx/nginx.conf /tmp/nginx.conf
        docker rm temp-fe
        # Build upstream server list for all backends
        BACKEND_SERVERS=""
        {% for ip in backend_ips.split(',') %}
        BACKEND_SERVERS="${BACKEND_SERVERS}    server {{ ip }}:8080;\n"
        {% endfor %}
        # Replace placeholder with actual backend servers
        sed -i "s|# BACKEND_SERVERS|${BACKEND_SERVERS}|g" /tmp/nginx.conf
      args:
        executable: /bin/bash

    - name: Create dms-fe systemd service
      ansible.builtin.copy:
        dest: /etc/systemd/system/dms-fe.service
        content: |
          [Unit]
          Description=DMS Frontend Service
          After=docker.service
          Requires=docker.service

          [Service]
          TimeoutStartSec=0
          Restart=always
          ExecStartPre=-/usr/bin/docker stop dms-fe
          ExecStartPre=-/usr/bin/docker rm dms-fe
          ExecStartPre=/usr/bin/docker pull {{ docker_user }}/dms-fe:{{ frontend_version }}
          ExecStart=/usr/bin/docker run --rm --name dms-fe -p 80:80 -v /tmp/nginx.conf:/etc/nginx/nginx.conf:ro {{ docker_user }}/dms-fe:{{ frontend_version }}

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      notify: Restart dms-fe

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: yes

    - name: Ensure dms-fe service is enabled and started
      ansible.builtin.systemd:
        name: dms-fe
        enabled: yes
        state: started

    - name: Flush handlers
      ansible.builtin.meta: flush_handlers

    - name: Wait for the app to be ready
      ansible.builtin.uri:
        url: "http://localhost:80"
        status_code: [200, 302]
        return_content: no
      register: app_ready
      until: app_ready.status == 200 or app_ready.status == 302
      retries: 20
      delay: 5

  handlers:
    - name: Restart dms-fe
      ansible.builtin.systemd:
        name: dms-fe
        state: restarted
