---
- name: Configure Frontend Application
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Log in to Docker Hub
      ansible.builtin.shell: "docker login -u {{ docker_user }} -p {{ docker_password }}"
      register: docker_login_result
      changed_when: false
      no_log: true

    - name: Create dms-fe systemd service
      ansible.builtin.copy:
        dest: /etc/systemd/system/dms-fe.service
        content: |
          [Unit]
          Description=DMS Frontend Service
          After=docker.service
          Requires=docker.service

          [Service]
          TimeoutStartSec=0
          Restart=always
          ExecStartPre=-/usr/bin/docker stop dms-fe
          ExecStartPre=-/usr/bin/docker rm dms-fe
          ExecStartPre=/usr/bin/docker pull {{ docker_user }}/dms-fe:{{ frontend_version }}
          ExecStart=/usr/bin/docker run --rm --name dms-fe -p 8080:8080 {{ docker_user }}/dms-fe:{{ frontend_version }}

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      notify: Restart dms-fe

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: yes

    - name: Ensure dms-fe service is enabled and started
      ansible.builtin.systemd:
        name: dms-fe
        enabled: yes
        state: started

    - name: Wait for the app to be ready
      ansible.builtin.uri:
        url: "http://localhost:8080"
        status_code: [200, 302]
        return_content: no
      register: app_ready
      until: app_ready.status == 200 or app_ready.status == 302
      retries: 20
      delay: 5

  handlers:
    - name: Restart dms-fe
      ansible.builtin.systemd:
        name: dms-fe
        state: restarted
