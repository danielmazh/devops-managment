---
- name: Configure Backend Application
  hosts: all
  become: true
  gather_facts: false
  vars:
    docker_platform: "linux/amd64"

  tasks:
    - name: Install Docker engine
      ansible.builtin.apt:
        name: docker.io
        state: present
        update_cache: yes

    - name: Ensure Docker service is running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    - name: Log in to Docker Hub
      ansible.builtin.shell: "docker login -u {{ docker_user }} -p {{ docker_password }}"
      register: docker_login_result
      changed_when: false
      no_log: true

    - name: Pull Backend Image
      ansible.builtin.shell: "docker pull --platform {{ docker_platform }} {{ docker_user }}/dms-be:{{ backend_version }}"
      register: docker_pull_result

    - name: Create dms-be systemd service
      ansible.builtin.copy:
        dest: /etc/systemd/system/dms-be.service
        content: |
          [Unit]
          Description=DMS Backend Service
          After=docker.service
          Requires=docker.service

          [Service]
          TimeoutStartSec=0
          Restart=always
          ExecStartPre=-/usr/bin/docker stop dms-be
          ExecStartPre=-/usr/bin/docker rm dms-be
          ExecStartPre=/usr/bin/docker pull --platform {{ docker_platform }} {{ docker_user }}/dms-be:{{ backend_version }}
          ExecStart=/usr/bin/docker run --rm --platform {{ docker_platform }} --name dms-be -p 8080:8080 {{ docker_user }}/dms-be:{{ backend_version }}

          [Install]
          WantedBy=multi-user.target
        mode: '0644'
      notify: Restart dms-be

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: yes

    - name: Ensure dms-be service is enabled and started
      ansible.builtin.systemd:
        name: dms-be
        enabled: yes
        state: started

    - name: Flush handlers
      ansible.builtin.meta: flush_handlers

    - name: Wait for the app to be ready
      ansible.builtin.uri:
        url: "http://localhost:8080/health"
        status_code: [200]
        return_content: no
      register: app_ready
      until: app_ready.status == 200
      retries: 20
      delay: 5

  handlers:
    - name: Restart dms-be
      ansible.builtin.systemd:
        name: dms-be
        state: restarted
