---
- name: Domain Monitoring System - API Test Suite
  hosts: all
  gather_facts: yes
  
  tasks:
    - name: Install python3-requests
      package:
        name: python3-requests
        state: present
      become: yes
      ignore_errors: yes

    - name: Execute API test script
      ansible.builtin.script: ../scripts/test-app/test-api/test_api.py
      args:
        executable: python3
      register: test_result
      ignore_errors: yes

    - name: Print test output
      debug:
        var: test_result.stdout_lines
      
    - name: Fail if tests failed
      fail:
        msg: "API tests failed"
      when: test_result.rc != 0
